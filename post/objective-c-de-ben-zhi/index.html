<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title> Objective-C 对象的本质 | LemonMeow</title>

<link rel="shortcut icon" href="https://lemonMeow.github.io/favicon.ico?v=1600616521541">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://lemonMeow.github.io/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            LemonMeow
        </div>
    </div>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1600616521541" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                     Objective-C 对象的本质
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2020-09-20 ·
                    </time>
                    
                </div>
                
                <div class="post-content">
                    <p><strong>OC对象的本质</strong></p>
<p>我们平时编写的Objective-C的代码，实际底层都是c/c++代码。<br>
<img src="https://lemonMeow.github.io/post-images/1600616296925.png" alt="" loading="lazy"><br>
所以OC的面向对象都是基于c/c++的数据结构实现的 - <strong>结构体</strong></p>
<h2 id="nsobject-的底层实现">NSObject 的底层实现</h2>
<p>让我们围绕 <code>NSObject *obj = [[NSObject alloc] init];</code> 进行解析。首先<code>NSObject</code>在.h文件中的定义如下:</p>
<pre><code>// NSObject.h
@interface NSObject &lt;NSObject&gt; {
    Class isa;
}
</code></pre>
<p>c++底层代码如下：</p>
<pre><code>struct NSObject_IMPL {
	Class isa; //在64bit 中 isa占8个字节
};

//结构体中Class的定义
typedef struct objc_class *Class;
</code></pre>
<p>从c++代码可以看出，<code>NSObject</code>本质是结构体，其中<code>Class</code>是一个指向结构的指针</p>
<h2 id="实例对象占用内存空间大小64bit">实例对象占用内存空间大小(64bit)</h2>
<pre><code>NSObject *obj = [[NSObject alloc] init];
</code></pre>
<p>这个位置其中有两个容易混淆的概念，<mark>实例对象分配内存大小</mark>和<mark>实例对象的成员变量所占用的大小</mark></p>
<ul>
<li>创建一个实例对象，至少需要多少内存？<br><br>
结构体至少需求的大小（类的实例对象的成员变量所占大小）以其中最大成员变量大小的整数倍对齐（NSObject的最大成员变量字节是8，即以8字节对齐）</li>
</ul>
<pre><code>#import &lt;objc/runtime.h&gt;
class_getInstanceSize([NSObject class]); // 此例结果为 8
</code></pre>
<ul>
<li>创建一个实例对象，实际上分配了多少内存？<br><br>
操作系统内存计算（类的实例对象分配内存大小）以16字节对齐</li>
</ul>
<pre><code>#import &lt;malloc/malloc.h&gt;
malloc_size((__bridge const void *)obj); // 此例结果为 16
</code></pre>
<p>另一个容易混淆的概念<code>sizeof()</code></p>
<p>也能计算内存大小，不同的是，首先他是编译时就会知道<mark>类型</mark>从而计算内存大小；实质上他是个运算符而不是函数</p>
<pre><code>struct NSObject_IMPL {
    Class isa;
};

struct Student_IMPL {
    Class isa;
    int _no;
    int _age;
};

@interface Student : NSObject
{
    int _no;
    int _age;
}
@end

Student *stu = [[Student alloc] init];

NSLog(@&quot;%lu&quot;,sizeof(struct Student_IMPL)); // 16 

NSLog(@&quot;%zd&quot;, class_getInstanceSize([Student class])); // 16 

NSLog(@&quot;%zd&quot;, malloc_size((__bridge const void *)stu)); // 16

// 如果此时Student_IMPL做一些修改

struct Student_IMPL {
    int _no;
    int _age;
};

// 上面3个log结果分别为：8、16、16
// 解析：
// sizeof()是在编译就会计算一个给定的类型的大小，就相当与是一个宏定义，已经固定好的格式。
// class_getInstanceSize()是运行时计算对象的成员变量的大小

</code></pre>
<h2 id="oc对象分类">OC对象分类</h2>
<ul>
<li>instance - 实例对象</li>
<li>Class - 类对象</li>
<li>metaClass - 元类对象</li>
</ul>
<h3 id="instance-实例对象">instance - 实例对象</h3>
<pre><code class="language-objc">BXPerson *person1 = [[BXPerson alloc] init];
BXPerson *person2 = [[BXPerson alloc] init];
// 这是两个不同的实例对象
</code></pre>
<p><strong>What is instance？</strong></p>
<ul>
<li>instace对象就是通过类clloc出来的对象，每次调用alloc都会产生一个新的对象，所以一个类可能有多个isntance对象</li>
<li>多个instance对象占用不同的内存</li>
</ul>
<p><strong>instance对象内存中储存的信息？</strong></p>
<ul>
<li>isa指针</li>
<li>其他成员变量</li>
</ul>
<h3 id="class-类对象">Class - 类对象</h3>
<pre><code class="language-objc">Class personClass1 = [person1 class];
Class personClass2 = [person2 class];
Class personClass3 = object_getClass(person1);
Class personClass4 = object_getClass(person2);
Class personClass5 = [BXPerson class];
// personClass 1~5 都是同一个对象，打印的内存地址是一样的
</code></pre>
<p><strong>What is class？</strong></p>
<ul>
<li>实质是一个结构体的指针。typedef struct objc_class *Class;</li>
<li>每个类的内存中有且只有一个类对象</li>
</ul>
<p><strong>class对象内存中储存的信息？</strong></p>
<ul>
<li>isa指针</li>
<li>superclass指针</li>
<li>类的<mark>属性</mark>信息（@property）、类的<mark>对象方法</mark>信息（instance method）</li>
<li>类的<mark>协议</mark>信息（@protocol）、类的<mark>成员变量</mark>信息（ivar）</li>
</ul>
<h3 id="metaclass-元类对象">metaClass - 元类对象</h3>
<pre><code class="language-objc">Class personMetaClass1 = object_getClass([BXPerson class]);
Class personMetaClass2 = object_getClass(personClass1);
Class personMetaClass3 = object_getClass([person1 class]);
// personMetaClass 1~3 都是同一个对象，打印的内存地址是一样的
</code></pre>
<p><strong>What is metaClass？</strong></p>
<ul>
<li>每个类的内存中有且只有一个metaClass - 元类对象</li>
</ul>
<p><strong>metaClass对象内存中储存的信息？</strong></p>
<ul>
<li>isa指针</li>
<li>superClass指针</li>
<li>类的类方法信息（class method）（以实例方法的形式存在？）</li>
<li>...</li>
</ul>
<p>通过代码可以看出，元类对象与类对象的结构一致都是Class，所以内存中存储的结构也是一致的, 不同的是</p>
<ul>
<li>在类的内存中, 类的类方法信息（class method）为null;</li>
<li>在元类的内存中，类的属性、对象方法、协议信息、成员变量 都为NULL;</li>
</ul>
<h2 id="知识积累">知识积累</h2>
<p><strong>这段代码中personClass始终是类对象，也就是说class这个oc方法，返回的就是类对象。</strong></p>
<pre><code class="language-objc">Class personClass = [[[person1 class] class] class];
</code></pre>
<p><strong>判断是否是元类对象的方法</strong></p>
<pre><code class="language-objc">BOOL ismetaclass = class_isMetaClass(personMetaClass1);
</code></pre>
<p><strong>object_getClass(id  _Nullable obj);</strong></p>
<pre><code class="language-c++">// 源码
Class object_getClass(id obj)
{
    if (obj) return obj-&gt;getIsa();
    else return Nil;
}
</code></pre>
<table>
<thead>
<tr>
<th>传入</th>
<th>返回</th>
</tr>
</thead>
<tbody>
<tr>
<td>instance对象</td>
<td>返回class对象</td>
</tr>
<tr>
<td>class对象</td>
<td>metaClass对象</td>
</tr>
<tr>
<td>metaClass对象</td>
<td>NSObject（基类）的metaClass对象</td>
</tr>
</tbody>
</table>
<p><strong>Class objc_getClass()</strong></p>
<pre><code class="language-c++">// 源码
Class objc_getClass(const char *aClassName)
{
    if (!aClassName) return Nil;

    // NO unconnected, YES class handler
    return look_up_class(aClassName, NO, YES);
}
</code></pre>
<ul>
<li>传入一个字符串</li>
<li>返回相对应的类对象</li>
</ul>
<p><strong>+(Class)class; &amp; -(Class)class;</strong></p>
<pre><code class="language-c++">// 源码
- (Class)class {
    return object_getClass(self);
}

+ (Class)class {
    return self;
}
</code></pre>
<p><strong>将Objective-C代码转换为C\C++代码</strong></p>
<p><code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc OC源文件 -o 输出的CPP文件</code></p>
<p>如果需要链接其他框架，使用-framework参数。比如-framework UIKit</p>
<h3 id="利用xcode实时查看内存数据">利用Xcode实时查看内存数据</h3>
<ul>
<li>Xcode工具路径：Debug -&gt; Debug Workfllow -&gt; View Memory （Shift + Command + M）<br>
<img src="https://lemonMeow.github.io/post-images/1600616487064.png" alt="" loading="lazy"></li>
<li>也可以使用下面LLDB命令</li>
</ul>
<h3 id="常用的lldb指令">常用的LLDB指令</h3>
<ul>
<li>print、p：打印</li>
<li>po：打印对象</li>
<li>读取内存
<ul>
<li>memory read/数量·格式·字节数 内存地址
<ul>
<li>x/数量·格式·字节数 内存地址</li>
<li>x/3xw 0x10010</li>
</ul>
</li>
<li>格式
<ul>
<li>x是16进制，f是浮点，d是10进制</li>
</ul>
</li>
<li>字节大小
<ul>
<li>b：byte 1字节，h：half word 2字节</li>
<li>w：word 4字节，g：giant word 8字节</li>
</ul>
</li>
</ul>
</li>
<li>修改内存中的值
<ul>
<li>memory  write  内存地址  数值</li>
<li>memory  write  0x0000010  10</li>
</ul>
</li>
</ul>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://lemonMeow.github.io/post/oc-gao-ji-mian-shi-ti/" class="post-title gt-a-link">
                    OC高级面试题
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
